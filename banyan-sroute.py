#!/usr/bin/env python3
"""
    Banyan Static Router

    Generates headers for a set of static routes of 2-party calls
    in a UoB Banyan-style network of switches. Provided no two sources
    require the same destination, a valid non-blocking route is guaranteed.

Usage:
    banyan-sroute.py -h
    banyan-sroute.py [-n=<n>] [-s=<s>] [<src--dst>...]

Options:
    -h, --help                  Print this help message.
    -n=<n>, --numports=<n>      The num of ports in the system [default: 8]
    -s=<s>, --midswitches=<s>   The num of middle-stage switches [default: 4]

Arguments:
    <src--dst>  Source and node IDs (up to numports instances). No repeated
                srcid or dstid allowed. Randomly generated by default.

"""

from docopt import docopt


class BSRoute:
    """
        Static route generator for Banyan-style networks.
    """

    def __init__(self, n, s, r):
        try:
            self.n = int(n, 0)
            self.s = int(n, 0)
            self.src = []
            self.dst = []
            if len(r) > 0:
                src, dst = [list(l) for l in zip(*[x.split('--') for x in r])]
                self.src = list(map(lambda i: int(i, 0), src))
                self.dst = list(map(lambda i: int(i, 0), dst))
            else:
                self.randroute()
        except ValueError:
            raise
        self.dupecheck(self.src)
        self.dupecheck(self.dst)
        self.rangecheck(self.src)
        self.rangecheck(self.dst)

    def rangeraise(self, v):
        raise ValueError("Value {} outside node range".format(v))


    def rangecheck(self, l):
        if max(l) >= self.n:
            self.rangeraise(max(l))
        if min(l) < 0:
            self.rangeraise(min(l))
    
    def dupecheck(self, l):
        seen = set()
        dupes = set(x for x in l if x in seen or seen.add(x))
        if len(dupes) > 0:
            raise ValueError('Duplicate value(s): {}'.format(list(dupes)))
        return

    def randroute(self):
        raise NotImplementedError

    def gen(self):
        raise NotImplementedError


if __name__ == "__main__":
    ARGS = docopt(__doc__, version="Banyan Static Router v0.0")
    BSR = BSRoute(ARGS['--numports'], ARGS['--midswitches'],
                  ARGS['<src--dst>'])
    BSR.gen()
